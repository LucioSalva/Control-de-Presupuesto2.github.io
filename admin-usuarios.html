<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <style>
    :root {
      visibility: hidden;
    }
  </style>

  <script>
    (function () {
      try {
        const u = localStorage.getItem("cp_usuario");
        const t = localStorage.getItem("cp_token");

        if (!u || !t) {
          window.location.replace("login.html");
          return;
        }

        document.documentElement.style.visibility = "visible";
      } catch (e) {
        document.documentElement.style.visibility = "visible";
      }
    })();
  </script>
  <title>Control de Presupuesto — Administración de Usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- CSS propio de esta página -->
  <link rel="stylesheet" href="css/admin-usuarios.css">
</head>

<body class="bg-light">
  <div class="container py-4">

    <!-- Encabezado -->
    <div class="page-header d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0">Administración de Usuarios</h4>

      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="btnVolver">
          Volver al panel
        </button>
        <button class="btn btn-sm btn-primary" id="btnNuevoUsuario">
          + Nuevo usuario
        </button>
      </div>
    </div>

    <!-- Alertas -->
    <div id="alertBox" class="alert d-none" role="alert"></div>

    <!-- Tarjeta con tabla -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">Usuarios del sistema</h6>
          <small id="usuariosResumen" class="text-muted"></small>
        </div>

        <div class="table-responsive border rounded-3">

          <table class="table table-hover align-middle" id="tablaUsuarios">

            <thead>
              <tr>
                <th class="text-nowrap">ID</th>
<th class="text-nowrap">Nombre completo</th>
<th class="text-nowrap">Usuario</th>
<!-- <th class="text-nowrap">Correo</th> -->
<th class="text-nowrap">Dependencia general</th>
<th class="text-nowrap">Dependencia auxiliar</th>
<th class="text-nowrap">Roles</th>
<th class="text-nowrap">Activo</th>
<th class="text-nowrap">Fecha creación</th>
<th class="text-nowrap text-center">Acciones</th>

              </tr>
            </thead>
            <tbody>
              <!-- Se llena por JS -->
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="text-center text-muted py-3 d-none">
          No se encontraron usuarios para mostrar.
        </div>
      </div>
    </div>

  </div>

  <!-- Modal Crear/Editar usuario -->
  <div class="modal fade" id="usuarioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="usuarioForm">
          <div class="modal-header">
            <h5 class="modal-title" id="usuarioModalLabel">Nuevo usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="usuarioId">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre completo</label>
                <input type="text" id="nombreCompleto" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Usuario</label>
                <input type="text" id="usuarioInput" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Correo</label>
                <input type="email" id="correo" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="form-label">Contraseña</label>
                <!-- SIN required para poder editar sin cambiar password -->
                <input type="password" id="password" class="form-control">
                <div class="form-text">
                  Al crear es obligatorio; al editar solo escribe una nueva si quieres cambiarla.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Dependencia general</label>
                <select id="idDgeneral" class="form-select">
                  <option value="">Seleccione...</option>
                </select>
                <div class="form-text">
                  Selecciona la dependencia general del usuario.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Dependencia auxiliar</label>
                <select id="idDauxiliar" class="form-select">
                  <option value="">Seleccione...</option>
                </select>
                <div class="form-text">
                  Selecciona la dependencia auxiliar del usuario.
                </div>
              </div>

              <div class="col-md-4 d-flex align-items-center mt-4">
                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="activo">
                  <label class="form-check-label" for="activo">
                    Usuario activo
                  </label>
                </div>
              </div>


              <div class="col-12">
                <label class="form-label">Roles</label>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input rol-check" type="checkbox" id="rolGod" value="GOD">
                    <label class="form-check-label" for="rolGod">
                      GOD (Superadministrador)
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input rol-check" type="checkbox" id="rolAdmin" value="ADMIN">
                    <label class="form-check-label" for="rolAdmin">
                      ADMIN (Administrador general)
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input rol-check" type="checkbox" id="rolArea" value="AREA">
                    <label class="form-check-label" for="rolArea">
                      AREA (Usuario de dependencia)
                    </label>
                  </div>
                </div>
                <div class="form-text">
                  Puedes asignar uno o varios roles. El rol <strong>GOD</strong> es el más alto.
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              Guardar usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS propio de esta página -->
  <script src="js/admin-usuarios.js"></script>
</body>

</html>